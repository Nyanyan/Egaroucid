<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/Nyanyan/Egaroucid/main/img/favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@takuto_yamana" />
<meta property="og:image" content="https://www.egaroucid.nyanyan.dev/ja/technology/explanation/img/eyecatch.png" />
<meta property="og:url" content="https://www.egaroucid.nyanyan.dev/ja/technology/explanation/" />
<meta property="og:title" content="技術解説 Egaroucid" />
<meta property="og:description" content="オセロAI Egaroucid 世界最強レベルのオセロAI Egaroucid を搭載したフリーソフトウェアです。搭載AIはコンテストで世界1位になった自作AIをベースに改良したものです。" />
<link rel="canonical" href="https://www.egaroucid.nyanyan.dev/ja/technology/explanation/">
<meta name="description" content="オセロAI Egaroucid 世界最強レベルのオセロAI Egaroucid を搭載したフリーソフトウェアです。搭載AIはコンテストで世界1位になった自作AIをベースに改良したものです。"/>

<script type="text/javascript" async>
    window.MathJax = {
        chtml: {
        matchFontHeight: false
        },
        tex: {
        inlineMath: [['$', '$']]
        },
        svg: {
        fontCache: 'global'
        }
    };
    (function () {
        const script = document.createElement('script');
        if (navigator.userAgent.includes("Chrome") || navigator.userAgent.includes("Firefox"))
            script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js";
        else
            script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js";
        script.async = true;
        document.head.appendChild(script);
    })();
</script>
<title>技術解説 Egaroucid</title>
</head>
<body>
<div class="menu_bar">
<div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/">ホーム</a></div><div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/download/">ダウンロード</a></div><div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/usage/">使い方</a></div><div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/console/">コンソール版</a></div><div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/web/">Web版</a></div><div class="menu_button"><a class="menu_a" href="https://www.egaroucid.nyanyan.dev/ja/technology/">技術</a></div></div>
<div class="box">
<p></p>
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="技術解説 Egaroucid - 最強レベルオセロAI" data-url="https://www.egaroucid.nyanyan.dev/ja/technology/explanation" data-hashtags="egaroucid" data-related="takuto_yamana" data-show-count="false"><span>Tweet</span></a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
<p><h1>Egaroucid 技術解説</h1></p><p></p><p><b>ここに書いた内容は高度なものです。一般的なアルゴリズムの話はしません。オセロAI初心者向け記事は<a href="https://note.com/nyanyan_cubetech/m/m54104c8d2f12" target="_blank" el=”noopener noreferrer”>こちら</a>に書きました。</b></p><p></p><p>このページは日本語のみで、のんびりと気が向いたときに書き足していきます。章立ての順番に意味はありません。読みたいところだけをぜひお読みください！</p><p></p><p>最終更新: 2024/02/17</p><p></p><p><details><summary>目次</summary><ol class="table_of_contents_ol"><span class="table_of_contents_li"><li><a href="#minimaxかMCTSか">minimaxかMCTSか</a><ul><li><a href="#minimaxかMCTSか_オセロでは精度の高い評価関数を簡単に作れるから">オセロでは精度の高い評価関数を簡単に作れるから</a></li><li><a href="#minimaxかMCTSか_オセロは合法手数が比較的少ないから">オセロは合法手数が比較的少ないから</a></li><li><a href="#minimaxかMCTSか_実験してみてあまり強くならなかったから">実験してみてあまり強くならなかったから</a></li><li><a href="#minimaxかMCTSか_完全読みの実装に繋げたいから">完全読みの実装に繋げたいから</a></li></ul></li></span><span class="table_of_contents_li"><li><a href="#評価関数">評価関数</a><ul><li><a href="#評価関数_石評価パターン">石評価パターン</a></li><li><a href="#評価関数_合法手評価パターン">合法手評価パターン</a></li><li><a href="#評価関数_その他の特徴量">その他の特徴量</a></li><li><a href="#評価関数_評価関数の強さよりも探索深さが大事？">評価関数の強さよりも探索深さが大事？</a></li></ul></li></span><span class="table_of_contents_li"><li><a href="#ボードの実装">ボードの実装</a></li></span><span class="table_of_contents_li"><li><a href="#枝刈り">枝刈り</a><ul><li><a href="#枝刈り_Negascout法">Negascout法</a></li><li><a href="#枝刈り_置換表による枝刈り (Transposition Cutoff)">置換表による枝刈り (Transposition Cutoff)</a></li><li><a href="#枝刈り_置換表による拡張した枝刈り(Enhanced Transposition Cutoff)">置換表による拡張した枝刈り(Enhanced Transposition Cutoff)</a></li><li><a href="#枝刈り_確定石による枝刈り (Stability Cutoff)">確定石による枝刈り (Stability Cutoff)</a></li><li><a href="#枝刈り_Multi-ProbCut">Multi-ProbCut</a></li></ul></li></span><span class="table_of_contents_li"><li><a href="#手の並び替え(Move Ordering)">手の並び替え(Move Ordering)</a><ul><li><a href="#手の並び替え(Move Ordering)_浅い探索の結果">浅い探索の結果</a></li><li><a href="#手の並び替え(Move Ordering)_着手するマスの位置">着手するマスの位置</a></li><li><a href="#手の並び替え(Move Ordering)_着手後の相手の合法手数">着手後の相手の合法手数</a></li><li><a href="#手の並び替え(Move Ordering)_着手後に自分の石に接している空きマスの数(潜在的着手可能数)">着手後に自分の石に接している空きマスの数(潜在的着手可能数)</a></li><li><a href="#手の並び替え(Move Ordering)_局面を4分割したときの空きマスの偶奇(準偶数理論)">局面を4分割したときの空きマスの偶奇(準偶数理論)</a></li></ul></li></span><span class="table_of_contents_li"><li><a href="#置換表(Transposition Table)">置換表(Transposition Table)</a></li></span><span class="table_of_contents_li"><li><a href="#並列化">並列化</a></li></span><span class="table_of_contents_li"><li><a href="#定数倍高速化">定数倍高速化</a></li></span><span class="table_of_contents_li"><li><a href="#特殊な終局への対策">特殊な終局への対策</a></li></span><span class="table_of_contents_li"><li><a href="#最終N手最適化">最終N手最適化</a><ul><li><a href="#最終N手最適化_1マス空きの最適化">1マス空きの最適化</a></li><li><a href="#最終N手最適化_2マス空きの最適化">2マス空きの最適化</a></li><li><a href="#最終N手最適化_3マス空きの最適化">3マス空きの最適化</a></li><li><a href="#最終N手最適化_4マス空きの最適化">4マス空きの最適化</a></li></ul></li></span><span class="table_of_contents_li"><li><a href="#GPUを使った探索">GPUを使った探索</a></li></span></ol></details></p><p></p><p><h2 id="minimaxかMCTSか">minimaxかMCTSか</h2></p><p></p><p>ゲームAIを作る上でのアルゴリズムは古くからminimax法が有名でした。1997年にチェスで人間を打ち負かしたDeep Blueも、同年にオセロで人間を打ち負かしたLogistelloも、このminimax法から派生するアルゴリズムでした。しかし、2000年に入るとMCTS(モンテカルロ木探索)が発展し、さらに2010年代にはMCTSをさらにアップデートしたPV-MCTS (Policy Value MCTS)が発展しました。2016年に囲碁で人間を打ち負かしたAlphaGoはPV-MCTSです。</p><p></p><p>この2つのアルゴリズムは根本から違うものです。将棋AIでは聞くところによるとすでにPV-MCTS優勢(2022年現在の伝聞)だそうですが、オセロにおいてはどちらを使うのが良いでしょうか。</p><p></p><p>オセロにおいてminimax系統が良いのかMCTS系統が良いのかは、まだ断言できないと思います。ですが、私はEgaroucidに対してminimax法から派生したNegascout法を利用しました。この理由について、軽くまとめます。</p><p></p><p><h3 id="minimaxかMCTSか_オセロでは精度の高い評価関数を簡単に作れるから">オセロでは精度の高い評価関数を簡単に作れるから</h3></p><p></p><p>minimax法では、計算量の問題で終局まで読みきれない場合には終局前に評価関数を使って、それをそのまま終局まで読んだ確定値と同じように利用します。つまり、評価関数の精度が悪ければ必然的にAIは弱くなります。</p><p></p><p>囲碁では評価関数が作りにくいようで、そのために評価関数を使わなくて済むMCTSが発展したそうです。</p><p></p><p>オセロにおいては、Logistelloに関する論文「Experiments with Multi-ProbCut and a New High-Quality Evaluation Function for Othello」でパターンを用いた評価関数が提案されてから、(それなりに)手軽に高精度の評価関数が作れるようになりました。ですので、この方法を踏襲すれば良かったわけです。</p><p></p><p><h3 id="minimaxかMCTSか_オセロは合法手数が比較的少ないから">オセロは合法手数が比較的少ないから</h3></p><p></p><p>MCTSは評価関数を必要としない以外にも利点があります。それは、合法手が多いゲームでもそれなりの性能が出せるところです。オセロは局面1つに対して概ね10手前後の合法手しかありませんが、例えば囲碁はとんでもないことになります。</p><p></p><p>各局面の合法手数を$b$、探索する深さを$d$とすると、minimax法の計算量は$b^d$、そしてminimax法に効果的な枝刈りを施したαβ法は$\sqrt{b^d}$です。これでは、合法手が多いゲームでは計算量が爆発しやすくなって困ります。</p><p></p><p>しかし、オセロに関して言えばこの問題は囲碁などのゲームと比較して大きくありません。</p><p></p><p><h3 id="minimaxかMCTSか_実験してみてあまり強くならなかったから">実験してみてあまり強くならなかったから</h3></p><p></p><p><a href="https://www.codingame.com/multiplayer/bot-programming/othello-1" target="_blank" el=”noopener noreferrer”>CodinGame Othello</a>というオセロAIのコンテストに参加しているときに、minimaxとMCTSを両方試してみたのですが、どうも私の実装ではMCTSがあまり強くなりませんでした。あくまでも私の実装力の範囲の話なので、本当にオセロにMCTSが向いていないのかを議論することはできませんが、とりあえずminimaxを使おうという結論になりました。</p><p></p><p><h3 id="minimaxかMCTSか_完全読みの実装に繋げたいから">完全読みの実装に繋げたいから</h3></p><p></p><p>Egaroucidでは終盤の決められた手数で完全読みをしてしまいます。完全読みはその名の通り、終局まで完璧に読み切ってしまうことですが、これはminimax系統のアルゴリズムで行います。Egaroucidでは完全読みの際、完全読み以前の探索結果を使うことで探索の高速化を実現しています。中盤探索をMCTSで作るとこのあたりの実装が多少煩雑になることが想像できます。</p><p></p><p></p><p></p><p><h2 id="評価関数">評価関数</h2></p><p></p><p>既存の強豪オセロAIに広く使われているパターン評価は、Logistelloで提案され、今日のEdaxまでほとんど形を変えずに受け継がれています。Egaroucidもこのパターン評価をベースにしていますが、少し特徴量を追加しました。</p><p></p><p>Egaroucidでは石自体をパターンとして評価する既存手法に加え、合法手をパターン化したもの、追加の特徴量の全ての得点の和を評価値としました。</p><p></p><p>評価関数は2手を1つのフェーズとして合計30フェーズ用意し、それぞれ大量の学習データを用意し、確率的勾配降下法で最適化しました。</p><p></p><p><h3 id="評価関数_石評価パターン">石評価パターン</h3></p><p></p><p>盤面のパターンとして使ったのは以下です。</p><p></p><div class="centering_box"><img width="400" height="400" class="pic2" src="img/pattern.png"><p></div></p><p></p><p><h3 id="評価関数_合法手評価パターン">合法手評価パターン</h3></p><p></p><p>Egaroucidでは独自の評価パターンとして、合法手のパターンを用いています。両手番の合法手か否かの情報を1マスにつき2bitで割り当て、8マスをセットにしてパターンとしています。</p><p></p><div class="centering_box"><img width="1141" height="284" class="pic2" src="img/legal_pattern.png"><p></div></p><p></p><p><h3 id="評価関数_その他の特徴量">その他の特徴量</h3></p><p></p><p>Egaroucidではさらに、それぞれの手番について以下の項目を計算し、特徴量に追加しました。</p><p></p><ul><li>石が空きマスに接している数</li><li>合法手数</li><li>石数</li><p></ul></p><p><h3 id="評価関数_評価関数の強さよりも探索深さが大事？">評価関数の強さよりも探索深さが大事？</h3></p><p></p><p>Egaroucid制作において評価関数を簡素なものから複雑なものまで色々試してみて気づいたのですが、評価関数の強さの差は探索深さを深くするとあまり目立たなくなるような気がします。</p><p></p><p>大規模な評価関数が小規模な評価関数に対して、1手読みでは勝率が55%程度あったのに10手読みでは51%となり、どんどん50%に漸近していく…という事例が多いように思います。</p><p></p><p>当然、だからといって簡素すぎる評価関数は当然強くならないのですが、ある程度の強さがあるのであれば評価関数の規模は大きくしてもあまり意味がないかもしれません。むしろ、大規模な評価関数は計算時間を増大させて、時間あたりの強さを減らすかもしれません。</p><p></p><p>いくら大規模化しようと、評価関数を線形に作っている以上、なかなか高精度な評価関数を作ることは難しいです。そうなれば、評価関数の規模を大きくするよりも、高速な評価関数を使って深くまで探索した方が良い気がしています。</p><p></p><p>現在(バージョン6.6.0制作中)、Egaroucidでは評価関数を簡素化してみる試みをしています。Egaroucid 6.5台の評価関数が結構完成度の高いものなので、どうなるかわかりませんが…</p><p></p><p></p><p></p><p><h2 id="ボードの実装">ボードの実装</h2></p><p></p><p>Egaroucidではボードの実装およびオセロのルールの実装にビットボードを使用しています。オセロは8x8の64マスの盤面を使うため、64bit整数2つを使い、自分の石のありなしを表すのに64bit、相手の石のありなしを表すのに64bit使うと収まりが良いです。</p><p></p><p>合法手生成や返る石の計算などをすべてビット演算で完結できるため、高速に動きます。</p><p></p><p></p><p></p><p><h2 id="枝刈り">枝刈り</h2></p><p></p><p>Egaroucidでは、様々な方法で探索を省略(枝刈り)しています。特に込み入った枝刈りはEdaxに実装されているものを参考にしています。</p><p></p><p><h3 id="枝刈り_Negascout法">Negascout法</h3></p><p></p><p>Egaroucidではminimax法系統の探索をしているので、Negascout法によって枝刈りを増やしています。Negascout法はαβ法に加え、最善(と思しき)手(Principal Variation = PV)を通常窓[α,β]で探索したら、残りの手を[α,α+1]でNull Window Search (NWS)します。これでfail highしたらPVを更新するために通常窓で探索し直して、fail lowしたらそのまま放置して良いです。</p><p></p><p>Negascoutについては、<a href="https://note.com/nyanyan_cubetech/n/nf810b043fb78" target="_blank" el=”noopener noreferrer”>note</a>に詳しく書きました。</p><p></p><p><h3 id="枝刈り_置換表による枝刈り (Transposition Cutoff)">置換表による枝刈り (Transposition Cutoff)</h3></p><p></p><p>ゲーム木はほとんど木構造として見なせるのですが、たまに合流する手筋があります。この際に同じ局面を再度探索しては無駄です。そのため、置換表(特殊なハッシュテーブル)に探索結果をメモしておきます。各ノードで探索前に置換表を参照して、値が登録されていればただちにそれを返せば良いです。また、評価値の下限値と上限値を登録しておくと、探索窓を狭める効果も期待できます。</p><p></p><p>置換表に値が登録されていたとしても、現在行っている探索よりも浅い探索の結果であればそれを採用してはいけません。Egaroucidでは評価値の下限と上限に加えて探索の深さとMulti ProbCutの確率、さらに探索の新しさを記録することで、現在行っている探索の結果として置換表の値を採用するかどうかを決定しています。</p><p></p><p>なお、置換表の参照にはオーバーヘッドがあるので、それが無視できるほど根に近いノードでのみ置換表へのアクセスを行います。根に近いノードでのみ行うことで、置換表に登録するデータを必要最低限に減らすこともできます。</p><p></p><p>さらに、置換表に過去の探索での最善手も一緒に記録しておくことで、現在の探索での手の並び替え(Move Ordering)にも使えます。</p><p></p><p><h3 id="枝刈り_置換表による拡張した枝刈り(Enhanced Transposition Cutoff)">置換表による拡張した枝刈り(Enhanced Transposition Cutoff)</h3></p><p></p><p>あるノードを探索するとき、そのノードが置換表に登録されていなくても、そのノードの子ノードを展開して置換表を参照すると、探索窓を狭めたり、評価値を確定できる場合があります。これはEdaxにてEnhanced Transposition Cutoff (ETC)として実装されているアイデアです。</p><p></p><p>あるノードを[α,β]の探索窓で探索するとします。また、子ノードを展開して、各子ノードについて置換表に記載されている(子ノードの手番から見た)最小値Lと最大値Hを見ていきます。すると、$\beta<\max(-\{L\})$であれば$\beta$を$\max(-\{L\})$に更新できますし、同様にして$\alpha>\max(-\{H\})$であれば$\alpha$を$\max(-\{H\})$に更新できます。</p><p></p><p>これは子ノードを展開した後に置換表の参照を繰り返すため、オーバーヘッドがかなり大きいです。根に近いノードでのみ行います。</p><p></p><p><h3 id="枝刈り_確定石による枝刈り (Stability Cutoff)">確定石による枝刈り (Stability Cutoff)</h3></p><p></p><p>ある盤面について、黒の確定石がB個、白の確定石がW個あれば、最終局面はB対64-Bから64-W対Wのどれかになるので、例えば黒目線での評価値(最終石差)は2B-64から64-2Wの中に入ることがわかります。これを用いて探索窓を狭めることができる場合があります。これはEdaxにてStability Cutoffとして実装されているアイデアです。</p><p></p><p>この手法は探索しているノードが終局に十分近い場合、つまり確定石が存在する可能性が高い場合にしか使えません。また、確定石の計算にはオーバーヘッドがありますので、あまりにも終局に近すぎると、単純に探索した方が速くなることも多くあります。</p><p></p><p>なお、確定石の個数が少ないと狭められる探索窓の範囲は-64や+64に近くなります。そのため、確定石を求める前に確定石の個数が少ないと見込まれる場合は、狭める対象の探索窓が-64や64などに近い領域を含んでいる場合のみ行います。確定石が多いと見込まれれば、狭める対象の探索窓が0に近い場合も枝刈りを試みます。確定石の個数の期待値は局面が進むにつれて増えていく傾向があるので、この見込みには深さと探索窓の上限/下限を対応づけたものを使用します。</p><p></p><p>確定石自体の計算には、</p><p></p><ul><li>過去の探索での最善手(置換表に登録されている値)</li><li>辺の確定石(事前計算しておき、辺の形を参照して決定する)</li><li>8方向(縦横斜め)全てのラインが他の石で埋まっている石を確定石とする</li><li>確定石に8近傍を囲まれた石を確定石とする(ループで処理する)</li><p></ul></p><p></p><p></p><p>を行っています。もちろん、これだけでは完璧に全ての確定石を求めることはできません。しかし、オセロAIの枝刈りという文脈ではこれで十分ですし、あまり正確にして遅くなっても意味がありません。</p><p></p><p><h3 id="枝刈り_Multi-ProbCut">Multi-ProbCut</h3></p><p></p><p>これは古くからある手法で、Logistelloで採用されたものです。Logistello以降も現在まで様々なオセロAIで採用されています。この手法は特殊な枝刈りで、探索結果が真の値であるという保証がなくなります。</p><p></p><p>こちらについてはすでに論文や解説が多いため、ここでの解説は省略します。</p><p></p><p></p><p></p><p><h2 id="手の並び替え(Move Ordering)">手の並び替え(Move Ordering)</h2></p><p></p><p>αβ法の流れを汲むゲーム木探索アルゴリズムでは、各ノードにおいて子ノードを有望な順(良さそうな手の順)に並べて、その順番に探索すると枝刈りが発生しやすくなります。この手の並べ替えをMove Orderingと言います。</p><p></p><p>ここでは、Egaroucidで使用しているMove Orderingを解説します。色々な特徴を使っていますが、Egaroucidでは常にすべての要素を使うのではなく、状況に応じて使用する特徴を変えています。</p><p></p><p><h3 id="手の並び替え(Move Ordering)_浅い探索の結果">浅い探索の結果</h3></p><p></p><p>浅い探索の結果で良いと判断された手は、深い探索でも良い手だろう、という考えに基づき、浅い探索の結果をMove Orderingに取り入れています。</p><p></p><p><h3 id="手の並び替え(Move Ordering)_着手するマスの位置">着手するマスの位置</h3></p><p></p><p>人力オセロでも隅が強いと言われるように、オセロというゲームではマスに応じて重要度が変わります。この性質を用いて、例えば隅に着手できるのであれば少し優先するなどの工夫をしています。</p><p></p><p><h3 id="手の並び替え(Move Ordering)_着手後の相手の合法手数">着手後の相手の合法手数</h3></p><p></p><p>自分の着手後、相手が打てる手が少ない手を優先します。これには2つの意味を考えられます。</p><p></p><p>まず、オセロというゲームが、相手の打てる場所(より正確には、人力オセロにおける手数(てかず)ですが、単に打てる場所と近似します)を減らしていくゲームであるということです。</p><p></p><p>また、合法手が少なければ、単純に展開すべき子ノードの数が少なく済むため、そういった貪欲法を続ければ探索に必要な訪問ノード数を減らせると期待できる面もあります。特にNull Window Search (NWS)においてfail highを狙う場合、fail highさえしてしまえば必ずしも最善手を探索する必要がないため、このMove Orderingが効果を発揮しやすいです。</p><p></p><p>なお、この合法手数が少ない順に探索する手法を「速さ優先探索」という場合もあるようです。</p><p></p><p>余談ですが、この「相手の合法手数」という単純な指標が、オセロというゲームの本質としても、さらにゲーム木探索の都合としても、双方から見て非常に合理的なのは、個人的に非常に美しい話だと思います。</p><p></p><p><h3 id="手の並び替え(Move Ordering)_着手後に自分の石に接している空きマスの数(潜在的着手可能数)">着手後に自分の石に接している空きマスの数(潜在的着手可能数)</h3></p><p></p><p>ある手を着手後、空きマスのうち、8近傍のいずれかで自分の石と接している空きマスが少ない手を優先します。これも相手の打てるところを減らしていくという話と大体同じ意味を持ちます。</p><p></p><p>オセロでは合法手は必ず空きマスに打つ手のみで、かつ、相手の石を挟んでひっくり返すというルールです。ですから、相手が着手する場所は、必ず空きマスであり、かつその空きマスに自分の石が1つ以上接しています。</p><p></p><p>自分の石に接している空きマスは、今すぐに相手の合法手になることはなくとも、将来的に相手の合法手になる可能性があります。そのため、こういった空きマスの数は少ない方が良いと判断します。この考え方を「潜在的着手可能数」と言ったりもします。</p><p></p><p>なお、人力オセロでは開放度という考え方がこのMove Orderingと似ていると思います。</p><p></p><p><h3 id="手の並び替え(Move Ordering)_局面を4分割したときの空きマスの偶奇(準偶数理論)">局面を4分割したときの空きマスの偶奇(準偶数理論)</h3></p><p></p><p>オセロでは、相手の石を挟んで返すというルールのため、対局の最後の着手によって置いた石、および返した石はひっくり返されることがありません。さらに、「局所的に」最後の1マスに着手した場合も似た話で、その着手によって置いた石は返した石は、再びひっくり返される危険性が少ないです。そのため、局所的な奇数マス空きには先着し、3マス空きなら自分→相手→自分のように、自分の着手でその局所を終わることが望ましいとされます。人力オセロではこの考え方を偶数理論と言います。偶数理論はその特徴上、オセロの終盤で非常に役立つ戦術です。</p><p></p><p>オセロにおいて偶数理論を近似的に実装したのが準偶数理論です(私が勝手に名付けました)。偶数理論の実装にあたって難しいのは「局所」の考え方です。そこで強い人同士のオセロの棋譜を眺めると、大抵終盤に空いたまま残るのは隅近くのマスだとわかります。この事実を踏まえて、準偶数理論ではこの「局所」を盤面を4×4の小盤面を4つに分割したものと固定してしまいます。それぞれの小盤面に属する空きマスの数を数えて、奇数空きの小盤面に属する合法手を優先して探索します。</p><p></p><p>なお、この解説は元々Edaxで使われていた"Parity Ordering"を私が解釈したものです。</p><p></p><p></p><p></p><p><h2 id="置換表(Transposition Table)">置換表(Transposition Table)</h2></p><p></p><p>置換表はハッシュテーブルとして実装します。しかしゲーム木探索において特殊な点が、必ずしも過去のデータを保持しなければいけないわけではないという点です。置換表にデータがなければまた探索すれば良いだけなので、置換表へのアクセスを高速化することに重点を置き、ハッシュが衝突した場合には過去のデータを書き換えてしまうなどの実装が適しています。</p><p></p><p>実際には、深い探索は再探索するのが大変なので優先的に残すなどの工夫をしています。また、ハッシュが衝突した場合にはメモリ上で隣の領域(別のハッシュ値が対応しています)が空いていればそこにデータを入れるなどの、軽いハッシュ衝突対策も行います。</p><p></p><p>ハッシュが衝突した場合に既存データと新データのどちらを残すかという問題ですが、Egaroucidは以下の指標を見て判断しています。上位のものほど優先されます。</p><p></p><ul><li>探索の新しさ(新しい探索の結果は優先的に残す)</li><li>そこに登録してある局面から先に読んだ手数(読みが深いほど探索が大変なので残す価値がある)</li><li>その局面を探索するときのMulti ProbCutの確率(MPCの確率が高いほど探索が大変で値が正確なので残す価値がある)</li><p></ul></p><p></p><p>このような扱いをして、さらに、置換表は基本的にリセットしないですべての探索で使い回すことにしています。</p><p></p><p></p><p></p><p></p><p><h2 id="並列化">並列化</h2></p><p></p><p>minimax系統のアルゴリズムはαβ法(αβ枝刈り)という手法で大幅な枝刈りを行えますが、これは逐次的に探索することを前提とした枝刈りなので、探索を並列化する場合には枝刈り効率が落ちないように注意する必要があります。</p><p></p><p>EgaroucidではYBWC(Young Brothers Wait Concept)を用いてCPUを使った並列化を行いました。YBWCは枝刈り効率を下げにくいままに、それなりの効率で並列化できる手法です。詳しい解説は他の人に委ねます。</p><p></p><p>YBWCはなかなか並列化効率を上げにくく、並列化を進めても手元の環境ではスピードは逐次探索と比べて6-7倍程度で頭打ちになります。現在、打開策を考えています。</p><p></p><p>ちなみに、Lazy SMPという並列化手法があり、これは試してみようと2回くらい実装してみたことがあるのですが、今のところうまくいっていません。他の実装例を見て勉強します。</p><p></p><p></p><p></p><p><h2 id="定数倍高速化">定数倍高速化</h2></p><p></p><p>minimax系統のアルゴリズムを使ったオセロAIはアルゴリズムの性質上、深く読むと深さに従って指数的に計算量が増大します。計算量自体を根底から改善することは不可能なので、ここで大事なのが定数倍の高速化です。</p><p></p><p>Egaroucidでは、ビットボードによる高速化や、SIMDを使った高速化、さらに最終盤の探索は空きマス数に応じて専用関数を使った最適化(最終N手最適化)を行うなどして定数倍高速化に努めました。</p><p></p><p>SIMDによる高速化は奥原氏によるEdaxのAVXを使った最適化の解説が大変参考になります。</p><p></p><ul><li><a href="http://www.amy.hi-ho.ne.jp/okuhara/bitboard.htm" target="_blank" el=”noopener noreferrer”>ビットボード関連の高速化</a></li><li><a href="http://www.amy.hi-ho.ne.jp/okuhara/edaxopt.htm" target="_blank" el=”noopener noreferrer”>ビットボード以外の高速化</a></li><p></ul></p><p></p><p></p><p></p><p><h2 id="特殊な終局への対策">特殊な終局への対策</h2></p><p></p><p>Egaroucidは序盤で中盤探索を行います。これは終局まで読みきらずに評価関数による評価値を探索結果として使った探索です。</p><p></p><p>しかし、当然ながら評価関数は完璧ではありません。例えば大量取りされた場合、圧倒的に有利なはずなのに間違って全滅筋に入ってしまうなど、評価関数だけでは見抜けない特殊な終局があります。</p><p></p><p>例えば以下の局面は白番ですが、白が圧倒的に有利な状況にあります。しかし、間違ってe6に白が置いてしまうと、黒e3で全滅して白は負けてしまいます。</p><p></p><div class="centering_box"><img width="400" height="400" class="pic2" src="img/clog.png"><p></div></p><p></p><p>こういった特殊な終局(有利だが一手だけ大悪手があるなど)の回避のため、Egaroucidではある程度の深さの考えうる全部の手を高速に列挙し、こういった特殊な終局が発見されないかを確認してから中盤探索を行っています。純粋にビットボードの処理だけしかしないため、非常に高速に実装できます。</p><p></p><p></p><p></p><p><h2 id="最終N手最適化">最終N手最適化</h2></p><p></p><p>オセロにおいて特徴的なのは、終盤の完全読みです。中盤探索については評価関数の精度によってミスをする可能性がありますが、完全読みさえしてしまえば、もうミスをする余地は(バグがない限り)一切ありません。</p><p></p><p>ですので、オセロAIの強さには完全読みの速さが大きく影響します。早い段階で完全読みを行えれば、オセロAIは強くなります。Egaroucidではレベルによって完全読みタイミングを変えていますが、例えばデフォルトのレベル21では24マス空き以降は完全読みを行います。また、レベル21では30マス空きから読み切り(終局まで探索するものの、悪手と思われる手を評価関数によって一部省いてしまう)も行います。</p><p></p><p>例えば24マス空きの完全読みでは1e7から1e8ほどと、それなりに多くのノードを訪問します。また、ゲーム木はその名の通り木構造ですから、葉に近いノードが非常に多いです。つまり、終局間近の数手だけ専用関数を使って頑張って高速化すれば、完全読み全体を高速化できる見込みがあるのです。</p><p></p><p>ということで、ここでは最終N手最適化として、Egaroucidで用いている最終1手から4手の最適化手法を解説します。</p><p></p><p>現実的には終局間近かどうかの判定は難しいので、盤面に空きマスが何マスあるかを見て専用関数への移行を行います。</p><p></p><p><h3 id="最終N手最適化_1マス空きの最適化">1マス空きの最適化</h3></p><p></p><p>通常、石数のカウントは盤面に石を置いた後に盤面の石を数えて行いますが、1マス空きについては、もはや盤面に石を置く処理すら不要です。必要なのは、</p><p></p><ul><li>現在の盤面の石差</li><li>空きマスに着手したときに返る石の数</li><p></ul></p><p></p><p>の2つの数だけです。</p><p></p><p>現在の盤面の石差は、盤面が必ず1マス空きであるという特性を利用すれば、一方のプレイヤの石数をカウントするだけで計算できます。</p><p></p><p>空きマスに着手したときに返る石の数は、専用関数を作って求めます。空きマスから縦横斜めの4方向についてそれぞれ返る石の数を求めて合計します。このとき、各ラインで返る石の数は事前計算で求めておいて、実際の探索ではラインの抜き出しと表引きで実装しました。</p><p></p><p>また、現在の盤面の石差を求めた時点で探索窓に比べて明らかに枝刈りできる場合は、返る石の数の計算を省略することも可能です。</p><p></p><p>なお、返る石の数が0であればパスの処理をしたり、両者置けない場合はそのまま終局にしたりするなどの処理が必要です。ここで、1マス空き(奇数マス空き)で終局するときには引き分けが存在しないことを利用すると、終局の処理を若干高速にできます。</p><p></p><p><h3 id="最終N手最適化_2マス空きの最適化">2マス空きの最適化</h3></p><p></p><p>2マス空きでは合法手生成を省いて、簡易的に空きマスの周りに相手の石があれば合法手として返る石を計算し、返る石があれば着手するという処理を行いました。</p><p></p><p>なお、2マス空きでは偶数理論もどき(手の並び替えの項目を参照)に意味がないため、手の並び替えは行いません。ただ、2連打が確定する手筋があればそちらを優先する(つまり、相手からも置ける可能性のあるマスを優先して探索する)などの工夫ができます。</p><p></p><p><h3 id="最終N手最適化_3マス空きの最適化">3マス空きの最適化</h3></p><p></p><p>3マス空きでは、偶数理論もどきによって手の並び替えを行えます。盤面のそれぞれの象限を見て、ある象限には1マス、別の象限では2マスの空きマスがあれば、1マスの空きを優先して着手します。この並べかえでは条件分岐をなくすため、マスの位置(0から63で表す)と象限を対応付けるbitをうまく使って、SIMDのshuffle関数と表引きを使うことで並び替えを実現しています。このアイデアはEdaxをAVXに最適化した<a href="http://www.amy.hi-ho.ne.jp/okuhara/edaxopt.htm" target="_blank" el=”noopener noreferrer”>奥原氏の解説</a>を参考にしました。</p><p></p><p>3マス空きでも2マス空きと同じように、合法手生成を省いて簡易的に合法手判定をして、順番に着手を試みます。3マス空きで終局する場合は、引き分けが存在しないので引き分けの処理を省いた関数で石差を計算します。</p><p></p><p><h3 id="最終N手最適化_4マス空きの最適化">4マス空きの最適化</h3></p><p></p><p>4マス空きでは、偶数理論もどきによって手の並べ替えを行います。象限ごとに1マス-1マス-2マス-0マスの空きがある場合、1マス空きの象限2つを優先して探索します。これも条件分岐をなくすため、3マス空きと同じようにshuffleを用いた最適化を行いました。</p><p></p><p>4マス空きでも合法手生成を省いて簡易的に合法手判定をして、順番に着手を試みます。</p><p></p><p></p><p></p><p><h2 id="GPUを使った探索">GPUを使った探索</h2></p><p></p><p>Egaroucidではバージョン6.5.2現在、CPUのみを使って探索を行っています。私のパソコンにはGPUが搭載されていることもあり、将来的にはGPUを有効活用してオセロAIを動かしたいと思っています。</p><p></p><p>方針としては、GPUでオセロの探索ができないか…？ということをやってみているのですが、結構大変そうです。一応、RTX3090 (GPU)でCore-i913900K (CPU)の探索スピードを超えるようなことは、できないことはなさそうな気がしています。非常に大変そうなのですが…</p><p></p><p>こちらについては現在研究中なので、まとまったタイミングで詳しく書いてみようと思います。</p><p></p><p>また、先人の記事が非常に参考になります。</p><p></p><ul><li><a href="https://primenumber.hatenadiary.jp/entry/2016/12/20/003746" target="_blank" el=”noopener noreferrer”>GPGPUで爆速でオセロを解く</a>: そすうぽよ氏による報告です。10マス空きをCPUの8倍速で処理したとのことです。</li><li><a href="https://github.com/primenumber/GPUOthello2" target="_blank" el=”noopener noreferrer”>GPUOthello2</a> そすうぽよ氏のGPUオセロに関するコードです。</li><li><a href="http://www.amy.hi-ho.ne.jp/okuhara/flipcuda.htm" target="_blank" el=”noopener noreferrer”>GPU computingによるbitboard実装の実験</a>: 奥原氏による報告です。5マス空きの完全読みを並列処理したものの、CPUより遅かったとのことです。</li><p></ul></p><p></p>
</div>
</body>
<div class="footer">
    <p>オセロ・Othelloは株式会社メガハウスの登録商標です。</p>
    <p>TM&© Othello,Co. and MegaHouse</p>
    <p>© 2021-2024 Takuto Yamana</div></p>
</div>
</html>
